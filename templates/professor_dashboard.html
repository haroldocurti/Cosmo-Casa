<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Professor - Cosmo Casa</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
</head>
<body class="conteudo-centralizado">
    <header class="brand-header">
        <img class="brand-logo" src="{{ url_for('static', filename='imagens/Group 3.png') }}" alt="Cosmo Casa logo">
    </header>
    <!-- Barra separada para a√ß√µes no canto superior direito -->
    <div class="topbar-actions-row">
        <div class="topbar-actions">
            <a href="{{ url_for('professor.professor_reset_password', next=request.path) }}" class="action-btn">Trocar senha</a>
            <a href="{{ url_for('professor.professor_logout') }}" class="action-btn danger">Sair</a>
        </div>
    </div>

    <!-- Barra de boas-vindas isolada -->
    <div class="topbar">
        <div class="user">Bem-vindo, {{ professor_nome or 'Professor' }}</div>
    </div>
    
    <main class="dashboard-container">
        <div class="page-grid">
            <section class="actions-column">
                <div class="dashboard-header">
                    <h2>Dashboard do Professor</h2>
                </div>
                {% if must_change_admin %}
                <div class="alert-banner">
                    <div class="msg">Sua senha padr√£o ainda est√° ativa. Por seguran√ßa, troque a senha.</div>
                    <a href="{{ url_for('professor.professor_reset_password', next=request.path) }}" class="action-btn">Trocar senha</a>
                </div>
                {% endif %}
                <!-- Cards de A√ß√µes Principais -->
                <div class="dashboard-grid">
            <!-- Card de Ranking -->
            <div class="dashboard-card">
                <h4>Ranking de Pontua√ß√µes</h4>
                {% if ranking %}
                <div class="ranking-list">
                    {% for item in ranking %}
                    <div class="ranking-item">
                        <span><strong>{{ loop.index }}. {{ item.nome }}</strong>: {{ item.total }} pontos ‚Äî Conclu√≠dos: {{ item.concluidos }} ‚Äî Tentativas: {{ item.tentativas }}</span>
                        <form method="POST" action="{{ url_for('professor.professor_excluir_aluno_ranking') }}">
                            <input type="hidden" name="aluno_id" value="{{ item.id }}" />
                            <button type="submit" class="action-btn danger">üóëÔ∏è</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state empty-state--compact">
                    <p>Ainda n√£o h√° pontua√ß√µes registradas.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Card de Cria√ß√£o de Sala -->
            <div class="dashboard-card">
                <h4>Criar Nova Sala</h4>
                <form method="POST" action="{{ url_for('professor.professor_criar_sala') }}" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="nome_sala" class="form-label">Nome da Sala</label>
                        <input type="text" id="nome_sala" name="nome_sala" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lista_alunos" class="form-label">Lista de Alunos (.txt)</label>
                        <input type="file" id="lista_alunos" name="lista_alunos" accept=".txt" class="form-input" required>
                        <small>Um aluno por linha</small>
                    </div>
                    
                    <button type="submit" class="action-btn success btn-block">
                        ‚ú® Criar Sala
                    </button>
                </form>
            </div>
                </div>
            </section>
        
        <!-- Se√ß√£o de Salas -->
        <section class="salas-column">
        <h3 class="section-title">Minhas Salas</h3>
        
        {% if salas %}
        <div class="salas-container">
            {% for sala in salas %}
            <div class="sala-card">
                <div class="sala-header">
                    <h4 class="sala-title">{{ sala.nome_sala }}</h4>
                </div>
                
                <div class="sala-code">
                    <span><strong>C√≥digo:</strong> {{ sala.codigo }}</span>
                    <button class="action-btn ml-auto btn-compact" onclick="copiarCodigo('{{ sala.codigo }}')">
                        üìã Copiar
                    </button>
                </div>
                
                <div class="sala-info">
                    <div class="sala-info-item">
                        <strong>Destino:</strong> {{ sala.destino }}
                    </div>
                    <div class="sala-info-item">
                        <strong>Nave:</strong> {{ sala.nave_id }}
                    </div>
                    <div class="sala-info-item">
                        <strong>Alunos:</strong> {{ sala.aluno_count }}
                    </div>
                    <div class="sala-info-item">
                        <strong>Criada:</strong> {{ sala.data_criacao }}
                    </div>
                </div>
                
                <div class="sala-actions">
                    <a href="{{ url_for('professor.professor_sala_detalhes', codigo_sala=sala.codigo) }}" class="action-btn info">
                        üëÅÔ∏è Ver detalhes
                    </a>
                    <a href="{{ url_for('tela_selecao', codigo_sala=sala.codigo) }}" class="action-btn success">
                        ‚úö Criar desafio
                    </a>
                    <form method="POST" action="{{ url_for('professor.professor_sala_fechar') }}" class="no-margin">
                        <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                        <button type="submit" class="action-btn danger">
                            üîí Fechar sala
                        </button>
                    </form>
                </div>
                
                {% if sala.desafios and sala.desafios|length > 0 %}
                <div class="desafios-container">
                    <h5 class="desafios-title">Desafios da Sala</h5>
                    
                    {% for d in sala.desafios %}
                    <div class="desafio-item">
                        <form method="POST" action="{{ url_for('professor.professor_editar_desafio') }}" class="desafio-form">
                            <div class="desafio-fields-grid">
                                <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                                <input type="hidden" name="desafio_index" value="{{ loop.index0 }}" />
                                <input type="text" name="titulo" value="{{ d.titulo if d.titulo else ('Desafio ' ~ loop.index) }}" class="form-input">
                                <input type="text" name="descricao" value="{{ d.descricao if d.descricao else d }}" class="form-input">
                            </div>
                            
                            <div class="desafio-buttons">
                                <button type="submit" class="action-btn success btn-compact">üíæ</button>
                                
                                <button type="button" class="action-btn btn-compact" 
                                        onclick="document.getElementById('select-form-{{ sala.codigo }}-{{ loop.index0 }}').submit();">
                                    ‚úì
                                </button>
                                
                                <button type="button" class="action-btn danger btn-compact"
                                        onclick="document.getElementById('delete-form-{{ sala.codigo }}-{{ loop.index0 }}').submit();">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </form>
                        
                        <form id="select-form-{{ sala.codigo }}-{{ loop.index0 }}" 
                              method="POST" 
                              action="{{ url_for('professor.professor_selecionar_desafio') }}" 
                              class="is-hidden">
                            <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                            <input type="hidden" name="desafio_index" value="{{ loop.index0 }}" />
                        </form>
                        
                        <form id="delete-form-{{ sala.codigo }}-{{ loop.index0 }}" 
                              method="POST" 
                              action="{{ url_for('professor.professor_excluir_desafio') }}" 
                              class="is-hidden">
                            <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                            <input type="hidden" name="desafio_index" value="{{ loop.index0 }}" />
                        </form>
                    </div>
                    {% endfor %}
                    
                    {% if sala.desafio_selecionado_index is not none %}
                    <div class="desafio-selecionado">
                        <strong>Desafio Selecionado:</strong>
                        <div class="mt-8">
                            {% set dsel = sala.desafios[sala.desafio_selecionado_index] %}
                            {% if dsel.descricao %}
                                {{ dsel.descricao }}
                            {% else %}
                                {{ dsel }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">      
            <h2 class="empty-text">Nenhuma sala criada ainda</h2>
            <p>Crie sua primeira sala virtual para come√ßar a jornada espacial com seus alunos!</p>
        </div>
        {% endif %}
        </section>

        
        </div>
    </main>
    
    <script>
        function copiarCodigo(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                alert('C√≥digo copiado: ' + codigo);
            }).catch(err => {
                alert('Erro ao copiar c√≥digo: ' + err);
            });
        }

        // Toggle de desafios dentro de cada sala-card
        document.addEventListener('DOMContentLoaded', function() {
            // Suporte a bot√µes dedicados (se existirem) com classe .toggle-desafios
            document.querySelectorAll('.toggle-desafios').forEach(button => {
                button.addEventListener('click', function(evt) {
                    evt.preventDefault();
                    const salaCard = this.closest('.sala-card');
                    if (salaCard) {
                        salaCard.classList.toggle('is-open');
                    }
                });
            });

            // Permitir colapsar/expandir ao clicar no t√≠tulo dos desafios
            document.querySelectorAll('.desafios-title').forEach(title => {
                title.addEventListener('click', function() {
                    const salaCard = this.closest('.sala-card');
                    if (salaCard) {
                        salaCard.classList.toggle('is-open');
                    }
                });
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/ws.js') }}"></script>
</body>
</html>
