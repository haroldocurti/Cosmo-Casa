<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cosmo Casa – Editor</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/habitat.css') }}">
</head>
<body>
<div class="app">
  <!-- Barra de navegação simples (ajustada para baixo/esquerda e estilo padronizado) -->
  <div class="fixed-actions">
    {% if session.get('missao_destino') and session.get('missao_nave') %}
      <a href="{{ url_for('missao.selecao_modulos', destino=session.get('missao_destino'), nave_id=session.get('missao_nave')) }}" class="botao">Voltar</a>
    {% else %}
      <a href="{{ url_for('tela_selecao') }}" class="botao">Voltar</a>
    {% endif %}
    <form id="finalizarForm" action="{{ url_for('missao.habitat_finalizar') }}" method="POST" class="form-no-margin">
      <input type="hidden" name="habitat_score" id="habitatScoreInput" value="0" />
      <button id="btn-finalizar" type="submit" class="botao" title="Monte seu habitat para liberar a finalização" disabled>Finalizar o Game</button>
    </form>
  </div>
  <!-- ESQUERDA -->
  <aside class="panel">
    <div class="logo">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M12 2l4 4-4 4-4-4 4-4zM4 14l4-4 4 4-4 4-4-4zm16 0l-4-4-4 4 4 4 4-4z"/>
      </svg>
      <div><div class="brand">Cosmo Casa</div><div class="brand-subtitle">Editor de Habitat</div></div>
    </div>

    <div class="section">
      <h4>Conexões</h4>
      <div class="palette">
        <div class="chip draggable" draggable="true" data-type="conn" data-rot="90"><div class="conn-rect"></div><span>90°</span></div>
        <div class="chip draggable" draggable="true" data-type="conn" data-rot="0"><div class="conn-bar"></div><span>0°</span></div>
        <div class="chip draggable" draggable="true" data-type="conn" data-rot="45"><div class="conn-bar rot-45"></div><span>45°</span></div>
        <div class="chip draggable" draggable="true" data-type="conn" data-rot="135"><div class="conn-bar rot-135"></div><span>135°</span></div>
      </div>
    </div>

    <div class="section">
      <h4>Formato do ambientes</h4>
      <div class="palette formats">
        <div class="chip draggable" draggable="true" data-type="module" data-shape="hex">
          <div class="hex">
            <svg viewBox="0 0 100 100" fill="none"><path d="M50 3 90 25 90 75 50 97 10 75 10 25Z" stroke="var(--lime)" stroke-width="6"/></svg>
          </div>
        </div>
        <div class="chip draggable" draggable="true" data-type="module" data-shape="pent">
          <div class="pent">
            <svg viewBox="0 0 100 100" fill="none"><path d="M50 5 93 38 77 92 23 92 7 38Z" stroke="var(--lime)" stroke-width="6"/></svg>
          </div>
        </div>
      </div>
      <div class="student">Nome do Aluno<br><span class="student-ip">IP da Sala</span></div>
    </div>
  </aside>

  <!-- TABULEIRO -->
  <main class="panel board-wrap">
    <div id="board" class="board" tabindex="0"></div>
    <div class="board-tools">
      <button id="btn-clear" class="botao" title="Limpar módulo desta peça">Limpar módulo</button>
      <button id="btn-remove" class="botao" title="Excluir peça selecionada">Excluir peça</button>
      
      {% if false %}{% endif %}
    </div>
  </main>

  <!-- DIREITA -->
  <aside class="panel">
    <div class="section"><h4>Função dos ambientes</h4></div>
    <div id="moduleList" class="mod-list">
      {% set labels = {
        'suporte': 'Módulo Suporte à Vida',
        'habitacional': 'Habitacional Privado',
        'refeicoes': 'Alimentação e Refeições',
        'medico': 'Médico',
        'exercicios': 'Exercícios',
        'trabalho': 'Trabalho e Pesquisa',
        'armazenamento': 'Armazenamento',
        'sanitario': 'Sanitário e Higiene',
        'blindagem': 'Blindagem/Proteção',
        'inflavel': 'Inflável Expansível',
        'airlock': 'Airlock',
        'tesserae': 'Estrutural Modular (TESSERAE)',
        'cultura': 'Cultura e Lazer',
        'robotico': 'Robótico Const./Manut.',
        'hidroponia': 'Produção de Alimentos',
        'controle': 'Controle e Comunicação',
        'multifuncional': 'Módulo Multifuncional',
        'imp3d': 'Impressão 3D/Manufatura'
      } %}
      {% if modulos_permitidos and modulos_permitidos|length > 0 %}
        {% for key in modulos_permitidos %}
          <button class="mod" data-mod="{{ key }}"><span class="sw"></span>{{ labels.get(key, key) }}</button>
        {% endfor %}
      {% else %}
        <div class="hint">Nenhum módulo disponível: selecione na etapa anterior.</div>
      {% endif %}
    </div>
    <div id="total-counter" class="hint">Módulos no tabuleiro: 0 / {{ max_modulos|default(0) }}</div>
    <div id="score-counter" class="hint">Pontuação do Habitat: 0</div>
    <div class="hint">
      • Arraste **conexões** e **formatos** para o tabuleiro.<br>
      • **Clique** em um módulo à direita para aplicar a **imagem do módulo** na peça **selecionada**.<br>
      • Dica: pressione **DEL** para remover a peça selecionada.
    </div>
    <div class="section">
      <h4>Ordem Lógica de Conexão</h4>
      <div class="hint">
        Por que seguir as instruções de conexão?<br>
        Ao chegar, a montagem correta dos habitats garante um ambiente seguro e funcional. Cada conexão tem um motivo: algumas partes são compatíveis, outras não. Seguir a lógica evita falhas e melhora a eficiência operacional.
      </div>
      <div class="hint tight">
        Ordem sugerida para montar o habitat:
        <br>1) Conectar <strong>Suporte à Vida</strong>
        <br>2) Integrar <strong>Habitacional</strong>
        <br>3) Acoplar <strong>Sanitário</strong>
        <br>4) Adicionar <strong>Alimentação/Refeições</strong>
        <br>5) Preparar <strong>Airlock</strong> para EVAs
        <br>6) Completar com <strong>Armazenamento</strong>, <strong>Pesquisa/Trabalho</strong>, <strong>Exercícios</strong>, <strong>Hidroponia</strong> e <strong>Impressão 3D</strong>
      </div>
      <div class="hint tight">
        Compatibilidade básica de conexões:
        <br>• <strong>Suporte à Vida</strong> deve estar ligado a Habitacional, Sanitário e Alimentação.
        <br>• <strong>Airlock</strong> conecta-se ao módulo estrutural próximo (hex/pent) e deve ter acesso livre.
        <br>• <strong>Sanitário</strong> e <strong>Hidroponia</strong> compartilham recursos de água.
        <br>• <strong>Impressão 3D</strong> e <strong>Armazenamento</strong> operam melhor em proximidade.
      </div>
    </div>
  </aside>
</div>

<script>
/* ---------- CONFIG: onde estão as IMAGENS dos módulos ---------- */
/* Troque os paths pelos seus arquivos (.svg/.png) em ./icons/     */
const MAX_MODULOS = {{ max_modulos|default(0) }};
const LIMITES_POR_TIPO = {{ limites_por_tipo|tojson if limites_por_tipo is defined else '{}' }};
const ICON_SRC = {
  suporte:        '{{ url_for('missao.icons', filename='suportevida.svg') }}',
  habitacional:   '{{ url_for('missao.icons', filename='privado.svg') }}',
  refeicoes:      '{{ url_for('missao.icons', filename='refeicao.svg') }}',
  medico:         '{{ url_for('missao.icons', filename='medicina.svg') }}',
  exercicios:     '{{ url_for('missao.icons', filename='exercicio.svg') }}',
  trabalho:       '{{ url_for('missao.icons', filename='pesquisa.svg') }}',
  armazenamento:  '{{ url_for('missao.icons', filename='armazenagem.svg') }}',
  sanitario:      '{{ url_for('missao.icons', filename='sanitario.svg') }}',
  blindagem:      '{{ url_for('missao.icons', filename='blindagem.svg') }}',
  inflavel:       '{{ url_for('missao.icons', filename='inflavel.svg') }}',
  airlock:        '{{ url_for('missao.icons', filename='airlock.svg') }}',
  tesserae:       '{{ url_for('missao.icons', filename='tesserea.svg') }}',
  cultura:        '{{ url_for('missao.icons', filename='cultura.svg') }}',
  robotico:       '{{ url_for('missao.icons', filename='robotica.svg') }}',
  hidroponia:     '{{ url_for('missao.icons', filename='hidroponia.svg') }}',
  controle:       '{{ url_for('missao.icons', filename='controle.svg') }}',
  multifuncional: '{{ url_for('missao.icons', filename='multifuncional.svg') }}',
  imp3d:          '{{ url_for('missao.icons', filename='impressora.svg') }}'
};

/* ---------- Drag & Drop da paleta ---------- */
const board = document.getElementById('board');
let currentSelection = null;

document.querySelectorAll('.draggable').forEach(el=>{
  el.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/plain', JSON.stringify({
      type: el.dataset.type,
      rot: el.dataset.rot || null,
      shape: el.dataset.shape || null
    }));
  });
});
board.addEventListener('dragover', e=> e.preventDefault());
board.addEventListener('drop', e=>{
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData('text/plain'));
  const x = e.offsetX, y = e.offsetY;
  createPiece(data, x, y);
});

/* ---------- Criar peça no tabuleiro ---------- */
function createPiece(data, x, y){
  const el = document.createElement('div');
  el.className = 'piece';
  el.style.left = x+'px'; el.style.top = y+'px';
  el.dataset.kind = data.type;

  if(data.type==='conn'){
    const child = document.createElement('div');
    if(data.rot==='90'){ child.className='conn-rect'; }
    else { child.className='conn-bar'; }
    el.appendChild(child);
    if(data.rot!=90) el.style.transform += ` rotate(${data.rot}deg)`;
  }else if(data.type==='module'){
    const existentes = document.querySelectorAll('.piece[data-kind="module"]').length;
    if (existentes >= MAX_MODULOS) {
      alert('Limite de módulos atingido: você levou apenas '+MAX_MODULOS+'. Remova um módulo para adicionar outro.');
      return;
    }
    // desenha forma (hex/pent)
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 100 100');
    svg.style.width='100px'; svg.style.height='100px';
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('fill','none');
    p.setAttribute('stroke','var(--lime)');
    p.setAttribute('stroke-width','6');
    p.setAttribute('d', data.shape==='hex'
      ? 'M50 3 90 25 90 75 50 97 10 75 10 25Z'
      : 'M50 5 93 38 77 92 23 92 7 38Z'
      //50 23
    );
    svg.appendChild(p);
    el.appendChild(svg);

    // reservado para a IMAGEM do módulo
    const img = document.createElement('img');
    img.className = 'icon';
    el.appendChild(img);
  }

  el.addEventListener('pointerdown', startDrag);
  el.addEventListener('click', ()=> selectPiece(el));
  board.appendChild(el);
  selectPiece(el);
  // Atualiza total de módulos no tabuleiro
  updateTotal();
}

/* ---------- Seleção e arraste das peças ---------- */
function selectPiece(el){
  if(currentSelection) currentSelection.classList.remove('select');
  currentSelection = el;
  if(currentSelection) currentSelection.classList.add('select');
}
let dragging=null, dx=0, dy=0;
function startDrag(e){
  dragging = e.currentTarget;
  const r = dragging.getBoundingClientRect();
  const br = board.getBoundingClientRect();
  dx = e.clientX - r.left; dy = e.clientY - r.top;
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', endDrag, {once:true});
}
function onMove(e){
  if(!dragging) return;
  const br = board.getBoundingClientRect();
  dragging.style.left = (e.clientX - br.left - dx + dragging.offsetWidth/2) + 'px';
  dragging.style.top  = (e.clientY - br.top  - dy + dragging.offsetHeight/2) + 'px';
}
function endDrag(){
  document.removeEventListener('pointermove', onMove);
  dragging=null;
  // Atualiza prontidão e pontuação ao finalizar arraste
  updateReadyAndScore();
}

/* ---------- Aplicar IMAGEM do módulo ao clicar na lista ---------- */
document.getElementById('moduleList').addEventListener('click', (e)=>{
  const btn = e.target.closest('.mod');
  if(!btn) return;
  if(!currentSelection){
    alert('Selecione um módulo no tabuleiro para aplicar a imagem.');
    return;
  }
  if(currentSelection.dataset.kind!=='module'){
    alert('A imagem só pode ser aplicada em um módulo (hexágono/pentágono).');
    return;
  }
  // Validações de ordem e compatibilidade básicas
  const placedKeys = Array.from(document.querySelectorAll('.piece[data-kind="module"] img.icon'))
    .map(img => img.alt)
    .filter(Boolean);
  const key = btn.dataset.mod;
  // Ordem lógica adicional: exigir Habitacional antes de Sanitário e Refeições
  if ((key === 'sanitario' || key === 'refeicoes') && !placedKeys.includes('habitacional')) {
    alert('Antes de aplicar "' + (btn.textContent || key) + '", conecte o módulo Habitacional.');
    return;
  }
  // Limite por tipo: permitir múltiplas unidades somente se selecionadas
  const maxPorTipo = (LIMITES_POR_TIPO && LIMITES_POR_TIPO[key] != null) ? LIMITES_POR_TIPO[key] : 0;
  const usadosDoTipo = placedKeys.filter(k => k === key).length;
  if (usadosDoTipo >= maxPorTipo) {
    const nome = (btn.textContent || key);
    if (maxPorTipo === 0) {
      alert('"' + nome + '" não foi levado na missão. Volte e selecione este módulo para utilizá-lo aqui.');
    } else if (maxPorTipo === 1) {
      alert('Você levou apenas 1 unidade de "' + nome + '". Remova a existente para trocar.');
    } else {
      alert('Limite atingido para "' + nome + '": ' + maxPorTipo + ' unidades foram levadas.');
    }
    return;
  }
  // Gate: exigir Suporte à Vida antes de alguns módulos críticos
  const requiresSuporte = ['habitacional','sanitario','refeicoes','hidroponia'];
  if (requiresSuporte.includes(key) && !placedKeys.includes('suporte')) {
    alert('Antes de aplicar "' + (btn.textContent || key) + '", conecte o módulo Suporte à Vida.');
    return;
  }
  // Gate de ordem sugerida: Suporte -> Habitacional -> Sanitário/Alimentação
  if (key === 'habitacional' && placedKeys.includes('sanitario')) {
    alert('Conecte Habitacional antes de Sanitário para manter a lógica de montagem.');
    return;
  }
  const src = ICON_SRC[key];
  if(!src){ alert('Imagem não configurada para: '+key); return; }
  const img = currentSelection.querySelector('img.icon');
  img.src = src;           // ← usa seu arquivo .svg/.png
  img.alt = key;
  updateBadges();
  updateReadyAndScore();
});

/* ---------- Delete: remove peça selecionada ---------- */
window.addEventListener('keydown', (e)=>{
  if(e.key==='Delete' && currentSelection){
    currentSelection.remove(); currentSelection=null;
    updateBadges();
    updateTotal();
  }
});

/* ---------- Limpar módulo da peça selecionada ---------- */
document.getElementById('btn-clear').addEventListener('click', ()=>{
  if(!currentSelection){ alert('Selecione uma peça para limpar o módulo.'); return; }
  if(currentSelection.dataset.kind!=='module'){ alert('A limpeza se aplica apenas a peças de módulo.'); return; }
  const img = currentSelection.querySelector('img.icon');
  if(img){ img.src=''; img.alt=''; }
  updateBadges();
  updateReadyAndScore();
});

/* ---------- Excluir peça selecionada via botão ---------- */
document.getElementById('btn-remove').addEventListener('click', ()=>{
  if(!currentSelection){ alert('Selecione uma peça para excluir.'); return; }
  currentSelection.remove(); currentSelection=null;
  updateBadges();
  updateTotal();
  updateReadyAndScore();
});

/* ---------- Contadores de quantidade ---------- */
function ensureBadges(){
  document.querySelectorAll('#moduleList .mod').forEach(btn=>{
    if(!btn.querySelector('.badge')){
      const b = document.createElement('span');
      b.className = 'badge';
      btn.appendChild(b);
    }
  });
}
function getUsedCounts(){
  const used = {};
  document.querySelectorAll('.piece[data-kind="module"] img.icon').forEach(img=>{
    const k = img.alt;
    if(k){ used[k] = (used[k]||0)+1; }
  });
  return used;
}
function updateBadges(){
  ensureBadges();
  const used = getUsedCounts();
  document.querySelectorAll('#moduleList .mod').forEach(btn=>{
    const key = btn.dataset.mod;
    const total = (LIMITES_POR_TIPO && LIMITES_POR_TIPO[key]!=null) ? LIMITES_POR_TIPO[key] : 0;
    const usedCount = used[key] || 0;
    const remaining = Math.max(0, total - usedCount);
    const badge = btn.querySelector('.badge');
    if(badge){
      badge.textContent = `${remaining}/${total}`;
      badge.classList.remove('warn','zero');
      if(remaining === 0){
        badge.classList.add('zero');
      } else if(remaining === 1){
        badge.classList.add('warn');
      }
    }
  });
}
function updateTotal(){
  const total = document.querySelectorAll('.piece[data-kind="module"]').length;
  const el = document.getElementById('total-counter');
  if(el){ el.textContent = `Módulos no tabuleiro: ${total} / ${MAX_MODULOS}`; }
}

/* ---------- Pontuação e prontidão para finalizar ---------- */
function computeHabitatScore(){
  const keys = Array.from(document.querySelectorAll('.piece[data-kind="module"] img.icon'))
    .map(img => img.alt).filter(Boolean);
  const pieces = Array.from(document.querySelectorAll('.piece[data-kind="module"]'));
  const connCount = document.querySelectorAll('.piece[data-kind="conn"]').length;
  let pontos = 0;
  const base = { suporte: 20, habitacional: 15, sanitario: 10, refeicoes: 10 };
  keys.forEach(k => { pontos += (base[k] || 6); });
  // Bônus de lógica de ordem
  const hasSup = keys.includes('suporte');
  const hasHab = keys.includes('habitacional');
  const hasSan = keys.includes('sanitario');
  const hasRef = keys.includes('refeicoes');
  if(hasSup && hasHab) pontos += 10;
  if(hasHab && hasSan) pontos += 6;
  if(hasHab && hasRef) pontos += 6;
  // Conexões (proxy: quantidade de peças de conexão)
  pontos += Math.min(connCount * 2, 20);
  // Precisão do grid: bônus por alinhamento próximo à grade de 20px
  pieces.forEach(p => {
    const x = parseFloat(p.style.left||'0');
    const y = parseFloat(p.style.top||'0');
    const rx = Math.min(x % 20, 20 - (x % 20));
    const ry = Math.min(y % 20, 20 - (y % 20));
    if(rx <= 3 && ry <= 3) pontos += 2;
  });
  // Penalização simples por sobreposição (centros muito próximos)
  let penal = 0;
  for(let i=0;i<pieces.length;i++){
    const a = pieces[i];
    const ax = parseFloat(a.style.left||'0');
    const ay = parseFloat(a.style.top||'0');
    for(let j=i+1;j<pieces.length;j++){
      const b = pieces[j];
      const bx = parseFloat(b.style.left||'0');
      const by = parseFloat(b.style.top||'0');
      const dx = ax - bx, dy = ay - by;
      const d = Math.hypot(dx, dy);
      if(d < 40) penal += 5;
    }
  }
  pontos -= Math.min(penal, 30);
  return { total: Math.max(0, Math.round(pontos)), detalhes: { modulos: keys.length, conexoes: connCount } };
}

function isHabitatReady(){
  const keys = Array.from(document.querySelectorAll('.piece[data-kind="module"] img.icon'))
    .map(img => img.alt).filter(Boolean);
  const connCount = document.querySelectorAll('.piece[data-kind="conn"]').length;
  return keys.includes('suporte') && keys.includes('habitacional') && keys.length >= 3 && connCount >= 1;
}

function updateReadyAndScore(){
  const scoreEl = document.getElementById('score-counter');
  const btn = document.getElementById('btn-finalizar');
  const hidden = document.getElementById('habitatScoreInput');
  const res = computeHabitatScore();
  if(scoreEl){ scoreEl.textContent = `Pontuação do Habitat: ${res.total}`; }
  if(hidden){ hidden.value = String(res.total); }
  const ready = isHabitatReady();
  if(btn){
    btn.disabled = !ready;
    btn.title = ready ? 'Pronto para finalizar' : 'Monte seu habitat (mínimo: Suporte + Habitacional + 1 conexão)';
  }
}

// Intercepta envio para garantir pontuação e prontidão
document.getElementById('finalizarForm').addEventListener('submit', (e)=>{
  if(!isHabitatReady()){
    e.preventDefault();
    alert('Monte seu habitat antes de finalizar. Mínimo: Suporte à Vida + Habitacional + 1 conexão.');
    return;
  }
  const res = computeHabitatScore();
  document.getElementById('habitatScoreInput').value = String(res.total);
});

// Inicialização de contadores
updateBadges();
updateTotal();
updateReadyAndScore();
</script>
</body>
</html>
